
# LABORATORIO 1 - Servidor Proxy a Apache Tomcat

Como ya hemos visto en el caso de Apache 2 <> Apache Tomcat, un servidor proxy actúa como intermediario entre un cliente (como un navegador web) y un servidor de aplicaciones (en este caso, Tomcat). Permite:

* Redirigir peticiones.
* Añadir capa de seguridad (TLS/SSL).
* Manejar balanceo de carga o compresión.
* Ofuscar la arquitectura del backend.


## 2. ¿Por qué usar Nginx como proxy para Tomcat?

Recordemos que Apache Tomcat sirve aplicaciones Java pero no está optimizado para manejar tráfico HTTP público. Nginx aporta:

* Rendimiento superior para servir contenido estático.
* Terminación SSL/TLS más eficiente.
* Mejores herramientas de logging y gestión de errores.
* Capacidad de filtrar o redirigir peticiones antes de que lleguen a Tomcat.

## 3. Arquitectura del escenario

Supongamos:

* Nginx escucha en el puerto 80 (HTTP) o 443 (HTTPS).
* Tomcat está desplegado en `localhost:8080`.
* Ambos servicios están en la misma máquina.

## 4. Instalación de Nginx y Tomcat (resumen rápido)

(OBVIAMOS ESTA PARTE, POR YA HABERLA REALIZAD AL PRINCIPIO DE ESTA PARTE DE NINGX.

## 5. Configuración básica de Nginx como reverse proxy para Tomcat

Edita el archivo de configuración en `/etc/nginx/sites-available/tomcat_proxy`:

```nginx
server {
    listen 80;
    server_name midominio.com;

    location / {
        proxy_pass http://localhost:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

Habilita el sitio:

```bash
sudo ln -s /etc/nginx/sites-available/tomcat_proxy /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

Ya está funcionando como proxy, pero sin HTTPS.

---

## 6. Securización con certificados autogenerados

### 6.1. Generar certificado autofirmado

```bash
sudo openssl req -x509 -nodes -days 365 \
  -newkey rsa:2048 \
  -keyout /etc/ssl/private/tomcat.key \
  -out /etc/ssl/certs/tomcat.crt
```

Responde a las preguntas del prompt (país, nombre de dominio, etc.).

### 6.2. Configurar Nginx con HTTPS y certificado autofirmado

```nginx
server {
    listen 443 ssl;
    server_name midominio.com;

    ssl_certificate /etc/ssl/certs/tomcat.crt;
    ssl_certificate_key /etc/ssl/private/tomcat.key;

    location / {
        proxy_pass http://localhost:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 80;
    server_name midominio.com;
    return 301 https://$host$request_uri;
}
```

Reinicia Nginx:

```bash
sudo nginx -t
sudo systemctl reload nginx
```

Este certificado **no será confiable para los navegadores** (salvo que lo aceptes manualmente).

---

## 7. Securización con certificados Let's Encrypt (Recomendado para producción)

### 7.1. Instalar Certbot

```bash
sudo apt install certbot python3-certbot-nginx
```

### 7.2. Ejecutar Certbot para Nginx

```bash
sudo certbot --nginx -d midominio.com
```

Certbot:

* Editará automáticamente la configuración de Nginx.
* Añadirá las directivas SSL correctas.
* Configurará redirección de HTTP a HTTPS.

### 7.3. Renovación automática

Certbot instala un cron job. Puedes verificar la renovación con:

```bash
sudo certbot renew --dry-run
```

---

## 8. Consideraciones de seguridad adicionales

* Usa headers seguros en Nginx:

```nginx
add_header X-Content-Type-Options nosniff;
add_header X-Frame-Options DENY;
add_header X-XSS-Protection "1; mode=block";
```

* Limita el tamaño de peticiones:

```nginx
client_max_body_size 10M;
```

* Usa fail2ban o un firewall (ufw) para proteger el servidor.

---

## 9. Verificación

* Accede desde el navegador a `https://midominio.com`.
* Verifica que el certificado sea válido (Let’s Encrypt).
* Observa que las peticiones sean correctamente redirigidas a Tomcat (`curl -I https://midominio.com` debería devolver encabezados de Nginx, pero servir contenido de Tomcat).

---

¿Quieres que prepare este contenido como un documento PDF o como material en formato diapositivas o Markdown para formación? También puedo incluir ejercicios prácticos o un script automatizado para todo el proceso.



# LABORATORIO 2 - Balaceo de Carga a 2 Servidores Apache Tomcat


# COMPARATIVA BALANCEO DE CARGA APACHE2 vs NGINX
  
Tanto **Apache HTTP Server (Apache2)** como **Nginx** ofrecen mecanismos para distribuir tráfico entre múltiples servidores backend, pero lo hacen con enfoques y características distintas.

### Similitudes entre Apache2 y Nginx en balanceo de carga

* **Funcionalidad proxy**: Ambos pueden actuar como *reverse proxy* para repartir peticiones entre varios servidores de aplicaciones.
* **Compatibilidad con HTTPS**: Ambos pueden terminar conexiones TLS/SSL y redirigir tráfico cifrado al backend.
* **Soporte de múltiples algoritmos**: Ambos permiten elegir estrategias como *round-robin*, *least connections*, o balanceo basado en IP.
* **Posibilidad de chequeos de salud (health checks)**: Aunque en distintos niveles, ambos pueden configurarse para detectar servidores backend caídos y evitarlos.

### Diferencias clave

| Característica                      | Apache2                                    | Nginx                                      |
| ----------------------------------- | ------------------------------------------ | ------------------------------------------ |
| **Modelo de procesamiento**         | Basado en hilos/procesos (prefork, worker) | Basado en eventos asíncronos               |
| **Eficiencia en alto volumen**      | Menor eficiencia bajo carga elevada        | Altamente eficiente para muchas conexiones |
| **Módulo de balanceo**              | `mod_proxy_balancer`                       | Balanceo integrado directamente            |
| **Configuración de algoritmos**     | Más extensa y granular, pero compleja      | Simple y directa                           |
| **Soporte de health checks nativo** | Limitado, requiere módulos adicionales     | Health checks integrados                   |
| **Monitorización y estadísticas**   | Amplia mediante `mod_status`               | Limitada, requiere herramientas externas   |

### Consideraciones generales

* **Apache2** es más flexible para entornos donde se necesite una configuración detallada, reglas complejas, o donde ya se use como servidor de aplicaciones (por ejemplo, PHP embebido).
* **Nginx**, por su arquitectura asíncrona, se comporta mucho mejor como proxy inverso en contextos de alto tráfico o aplicaciones modernas que usan contenedores, microservicios o servidores ligeros como Tomcat.


