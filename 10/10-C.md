# Configuraci√≥n b√°sica de Nginx.


El archivo de configuraci√≥n de Nginx puede describirse como una `lista de directivas` organizadas en una estructura l√≥gica. El comportamiento completo de la aplicaci√≥n est√° definido por los valores que asignamos a esas directivas.

Por defecto, Nginx hace uso de un √∫nico archivo de configuraci√≥n principal, que se ubica en `/etc/nginx/nginx.conf`. 

El archivo de configuraci√≥n de Nginx sigue una estructura modular, donde cada bloque (seccion, etc.) de configuraci√≥n est√° delimitado por llaves `{` `}`. Dentro de estos bloques, se definen directivas que especifican la configuraci√≥n del servidor web. 

Las directivas tienen la forma `directiva valor;`, donde `directiva` es el nombre de la configuraci√≥n que se desea establecer y `valor` es el valor asignado a esa configuraci√≥n.

Los bloques se consideran directivas que agrupan otras directivas. Sirven para categorizar/organizar el tipo de configuraci√≥n a la que hacen referencia.

Los comentarios en el archivo de configuraci√≥n comienzan con el s√≠mbolo `#` y pueden ser √∫tiles para documentar la configuraci√≥n o desactivar temporalmente partes del archivo.

Este es el archivo de configuraci√≥n de una instalaci√≥n por defecto de Nginx. Est√∫dialo.

```nginx
user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
        worker_connections 768;
        # multi_accept on;
}

http {

        ##
        # Basic Settings
        ##

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        # server_tokens off;

        # server_names_hash_bucket_size 64;
        # server_name_in_redirect off;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;
      ##
        # SSL Settings
        ##

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
        ssl_prefer_server_ciphers on;

        ##
        # Logging Settings
        ##

        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        ##
        # Gzip Settings
        ##

        gzip on;

        # gzip_vary on;
        # gzip_proxied any;
        # gzip_comp_level 6;
        # gzip_buffers 16 8k;
        # gzip_http_version 1.1;
        
        ##
        # SSL Settings
        ##

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
        ssl_prefer_server_ciphers on;

        ##
        # Logging Settings
        ##

        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        ##
        # Gzip Settings
        ##

        gzip on;

        # gzip_vary on;
        # gzip_proxied any;
        # gzip_comp_level 6;
        # gzip_buffers 16 8k;
        # gzip_http_version 1.1;
  
        ##
        # Virtual Host Configs
        ##

        include /etc/nginx/conf.d/*.conf;
        include /etc/nginx/sites-enabled/*;

#mail {
#       # See sample authentication script at:
#       # http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript
# 
#       # auth_http localhost/auth.php;
#       # pop3_capabilities "TOP" "USER";
#       # imap_capabilities "IMAP4rev1" "UIDPLUS";
# 
#       server {
#               listen     localhost:110;
#               protocol   pop3;
#               proxy      on;
#       }
# 
#       server {
#               listen     localhost:143;
#               protocol   imap;
#               proxy      on;
#       }
#}
```



1. **Usuario y procesos:**

`user www-data;`: Establece el usuario bajo el cual se ejecutar√°n los procesos de Nginx. El usuario `www-data` es el nombre com√∫nmente utilizado para el usuario del sistema bajo el cual se ejecutan los procesos del servidor web. Este usuario se utiliza para limitar los privilegios y reforzar la seguridad del servidor.

Cuando Nginx se inicia, los procesos del servidor web se ejecutan bajo el contexto del usuario `www-data`. Esto significa que el servidor web tiene acceso limitado a los recursos del sistema y solo puede realizar las acciones permitidas para ese usuario.

Al utilizar un usuario dedicado como `www-data`, se reduce el riesgo de que un atacante pueda comprometer el sistema a trav√©s de vulnerabilidades en el servidor web, ya que los procesos del servidor se ejecutan con un conjunto m√≠nimo de privilegios.


2. **Procesos de trabajo:**

`worker_processes auto;`: En Nginx, un `worker` se refiere a un proceso que se encarga de manejar las solicitudes (requests) de los clientes. Cuando Nginx recibe una solicitud HTTP, un worker es responsable de procesar esa solicitud y enviar la respuesta adecuada al cliente.

El n√∫mero de workers se configura mediante la directiva `worker_processes` y determina cu√°ntos procesos workers se crear√°n para manejar las solicitudes entrantes. Podemos establecer este valor en un n√∫mero espec√≠fico o usar `auto`, lo que permite que Nginx determine autom√°ticamente la cantidad √≥ptima de workers en funci√≥n de las capacidades del sistema.

Cada worker ejecuta de forma independiente y maneja m√∫ltiples conexiones de clientes simult√°neamente. Esto se logra mediante el uso de un modelo de concurrencia no bloqueante, que permite a cada worker manejar m√∫ltiples solicitudes de forma eficiente sin esperar a que una solicitud se complete antes de procesar otra.

El uso de m√∫ltiples workers permite a Nginx aprovechar al m√°ximo los recursos del sistema y escalar para manejar un alto volumen de solicitudes de manera eficiente. Adem√°s, este enfoque proporciona una mayor estabilidad y tolerancia a fallos al distribuir la carga de trabajo entre diferentes procesos.


3. **Identificador de proceso (PID):**

`pid /run/nginx.pid;`: La directiva `pid` en la configuraci√≥n de Nginx especifica la ubicaci√≥n del archivo donde se almacenar√° el ID de proceso (PID) del proceso principal de Nginx. El `PID` es un n√∫mero √∫nico asignado a cada proceso en el sistema operativo y se utiliza para identificar y controlar el proceso.

En el caso espec√≠fico de `pid /run/nginx.pid`, esta directiva establece que el PID del proceso principal de Nginx se guardar√° en el archivo `/run/nginx.pid`. En sistemas basados en Unix/Linux, el directorio `/run` es utilizado por muchos programas para almacenar archivos temporales o de estado, incluidos los archivos PID. El nombre del archivo en este caso es `nginx.pid`, donde `nginx` es el nombre del programa y `.pid` es una convenci√≥n com√∫n para indicar que el archivo contiene un PID.

Este archivo es √∫til para que las herramientas de administraci√≥n y monitorizaci√≥n pueden usar el PID almacenado en este archivo para identificar y controlar el proceso principal de Nginx. Por ejemplo, para ***reiniciar Nginx*** o ***verificar su estado***. Tambi√©n se utiliza para evitar iniciar m√∫ltiples instancias del proceso principal, ya que cualquier intento posterior de inicio puede verificar si ya hay un proceso en ejecuci√≥n usando el PID almacenado.


4. **Archivos de configuraci√≥n**

`include /etc/nginx/modules-enabled/*.conf;` en la configuraci√≥n de Nginx indica que se deben incluir todos los archivos `.conf` ubicados en el directorio `/etc/nginx/modules-enabled/`.

El comod√≠n `*` representa cualquier nombre de archivo que termine con `.conf`. En este caso, Nginx incluir√° todos los archivos `.conf` presentes en el directorio `/etc/nginx/modules-enabled/`.

El prop√≥sito de esta directiva es ***modularizar*** la configuraci√≥n de Nginx, como tambi√©n lo hace Apache, permitiendo que diferentes aspectos de la configuraci√≥n del servidor web est√©n separados en archivos individuales. Esto hace que la configuraci√≥n sea m√°s organizada, f√°cil de mantener y permite habilitar o deshabilitar m√≥dulos espec√≠ficos simplemente agregando o eliminando archivos de configuraci√≥n en el directorio especificado.


5. **Eventos:**

Define configuraciones relacionadas con los eventos de Nginx, en este caso se eslablece el n√∫mero m√°ximo de conexiones de los workers (`worker_connections`) en 768 conexiones. Es importante ajustar este valor seg√∫n la capacidad del servidor y la carga de trabajo esperada. Si hay demasiadas conexiones simult√°neas para el servidor, algunas solicitudes pueden ser rechazadas o experimentar tiempos de espera.


6. **Configuraci√≥n b√°sica de HTTP:**

Configuraciones como `sendfile`, `tcp_nopush`, `tcp_nodelay`, `keepalive_timeout`, y `types_hash_max_size` que afectan el comportamiento general del servidor web.  

Estas son directivas clave que se utilizan en la configuraci√≥n b√°sica de Nginx para optimizar el rendimiento del servidor web y controlar su comportamiento en relaci√≥n con la entrega de contenido y la gesti√≥n de conexiones. Aqu√≠ tienes una explicaci√≥n detallada de cada una:

`sendfile` controla si Nginx utiliza la funci√≥n de sistema `sendfile()` para enviar archivos est√°ticos al cliente.
Cuando esta directiva est√° activada (`on`), Nginx utiliza la funci√≥n del sistema `sendfile()` para enviar archivos est√°ticos al cliente. `sendfile()` es una funci√≥n del sistema operativo que permite la transferencia eficiente de datos desde un archivo a un socket, reduciendo la sobrecarga en la CPU y mejorando el rendimiento del servidor al enviar archivos grandes. Es especialmente √∫til para servir archivos est√°ticos como im√°genes, videos o archivos de audio. En valor predeterminado es `on`.

`tcp_nopush` controla si Nginx utiliza la funci√≥n `TCP_NOPUSH`, que es una funci√≥n de TCP que permite a Nginx enviar datos al cliente tan pronto como est√°n disponibles, en lugar de esperar a que se llene el b√∫fer. Esto puede mejorar la eficiencia y la capacidad de respuesta del servidor al transmitir contenido din√°mico o generarlo bajo demanda. El valor predeterminado es `on`.

`tcp_nodelay` controla si Nginx desactiva el algoritmo de retraso de TCP. Este algoritmo de retraso de TCP (TCP_NODELAY) controla si los paquetes de datos se env√≠an de inmediato o se agrupan para enviarlos juntos. Al desactivar TCP_NODELAY, Nginx env√≠a los datos al cliente tan pronto como est√©n disponibles, lo que puede reducir la latencia y mejorar la velocidad de entrega del contenido. El valor predeterminado es `on`.

`tcp_nopush` y `tcp_nodelay` no se usan a la vez por cada conexi√≥n, son mutuamente excluyentes en el mismo socket.:  
- nopush: agrupa ‚Üí espera
- nodelay: no espera ‚Üí env√≠a ya

Entonces: ¬øPor qu√© est√°n los dos en on entonces?
Porque Nginx los usa de forma inteligente y secuencial, seg√∫n el contexto de cada respuesta:

üîπ Usa tcp_nopush on; cuando:
Est√°s sirviendo archivos grandes con sendfile.

Nginx agrupa los datos para enviarlos m√°s eficientemente.

üîπ Luego activa tcp_nodelay on; cuando:
Ya termin√≥ de enviar el archivo est√°tico.

Pasa a manejar otras respuestas peque√±as (headers, ACKs, etc.).

`keepalive_timeout` especifica el tiempo de espera m√°ximo para mantener una conexi√≥n Keep-Alive abierta.
Keep-Alive es un mecanismo que permite que una conexi√≥n TCP se mantenga abierta despu√©s de que se haya completado una solicitud HTTP, lo que permite la reutilizaci√≥n de la misma conexi√≥n para realizar solicitudes adicionales. Esta directiva controla el tiempo m√°ximo (en segundos) que una conexi√≥n Keep-Alive puede permanecer abierta sin actividad antes de que se cierre. El valor predeterminado es `65`.

`types_hash_max_size`controla el tama√±o m√°ximo del cach√© de hash utilizado para buscar tipos MIME. Nginx utiliza un cach√© de hash para buscar el tipo MIME adecuado para los archivos servidos. Esta directiva especifica el tama√±o m√°ximo del cach√© de hash utilizado para almacenar esta informaci√≥n. El valor predeterminado es `2048`.

Estas l√≠neas en la configuraci√≥n de Nginx est√°n relacionadas con la gesti√≥n de los tipos MIME, que son utilizados para identificar el tipo de contenido que se est√° enviando desde el servidor al cliente. Aqu√≠ est√° la explicaci√≥n detallada de cada l√≠nea:


7. **Tipos MIME**:

`include /etc/nginx/mime.types;` indica a Nginx que incluya el archivo de tipos MIME que contiene una lista de extensiones de archivo junto con los tipos MIME correspondientes. Nginx utiliza esta informaci√≥n para determinar el tipo de contenido de los archivos que se est√°n enviando al cliente, lo que es importante para que el navegador del cliente pueda interpretar correctamente la respuesta del servidor.


8. **Tipo MIME predeterminado**:

`default_type application/octet-stream;` establece el tipo MIME predeterminado que se utilizar√° si no se puede determinar el tipo MIME de un archivo. Si Nginx no puede determinar el tipo MIME de un archivo basado en la extensi√≥n de archivo o en la configuraci√≥n de `mime.types`, utilizar√° el tipo MIME especificado aqu√≠. En este caso, `application/octet-stream` se utiliza com√∫nmente para representar un tipo de archivo binario gen√©rico, lo que significa que el navegador tratar√° el archivo como un flujo de datos binarios y no intentar√° interpretarlo como un tipo de contenido espec√≠fico.


9. **Configuraci√≥n SSL**:

`ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE` especifica los protocolos `SSL/TLS` que Nginx aceptar√° para las conexiones seguras.En este caso, se especifican los protocolos TLS versiones `1.0`, `1.1`, `1.2` y `1.3`. `SSLv3` est√° excluido expl√≠citamente, lo que mejora la seguridad del servidor al prevenir vulnerabilidades conocidas, como POODLE (Padding Oracle On Downgraded Legacy Encryption).


`ssl_prefer_server_ciphers on;` indica que Nginx debe preferir los cifrados del servidor sobre los cifrados del cliente en la negociaci√≥n SSL/TLS. Esto permite al servidor controlar los cifrados utilizados para garantizar una mayor seguridad y compatibilidad con los est√°ndares de seguridad del servidor.


10. **Registros (logs)**:

`access_log /var/log/nginx/access.log;` especifica la ubicaci√≥n del archivo de ***registro de acceso*** del servidor. En este archivo se registra todas las solicitudes que recibe en un archivo de registro de acceso. Esta directiva indica que la ruta del archivo donde se almacenar√°n estos registros es `/var/log/nginx/access.log`. Estos registros son √∫tiles para monitorear el tr√°fico del servidor, identificar problemas de rendimiento, analizar patrones de acceso y realizar an√°lisis de seguridad.

`error_log /var/log/nginx/error.log;` especifica la ubicaci√≥n del archivo de ***registro de errores*** del servidor. En este log se registran todos los errores y advertencias. Esta directiva indica que la ruta del archivo donde se almacenar√°n estos registros es `/var/log/nginx/error.log`. Estos registros son √∫tiles para diagnosticar problemas en el servidor, identificar errores de configuraci√≥n, registrar eventos inesperados y realizar tareas de depuraci√≥n.


11. **Configuraci√≥n de compresi√≥n (Gzip)**:

La l√≠nea `gzip on;` en la configuraci√≥n de Nginx habilita la compresi√≥n `gzip` para el contenido que se env√≠a desde el servidor al cliente, que es una t√©cnica de compresi√≥n de datos utilizada para reducir el tama√±o de los archivos antes de ser transferidos a trav√©s de la red.

Cuando la compresi√≥n gzip est√° habilitada, Nginx comprimir√° autom√°ticamente los archivos antes de enviarlos al navegador del cliente, lo que reduce el tiempo de carga de la p√°gina y el consumo de ancho de banda. Esto es especialmente √∫til para acelerar la carga de sitios web, especialmente en conexiones de red m√°s lentas o en dispositivos m√≥viles.


12. **Configuraci√≥n de hosts virtuales**:

Un host virtual en Nginx es una configuraci√≥n que permite alojar m√∫ltiples sitios web en un √∫nico servidor f√≠sico (de forma similar a Apache). Cada host virtual tiene su propio conjunto de configuraciones, como la direcci√≥n IP, los nombres de dominio, los registros de acceso y los registros de error. Esto permite que un servidor Nginx sirva diferentes sitios web en funci√≥n de la solicitud del cliente.

`include /etc/nginx/conf.d/*.conf;` incluye todos los archivos de configuraci√≥n `.conf` ubicados en el directorio `/etc/nginx/conf.d/`. Los archivos de configuraci√≥n en este directorio pueden contener configuraciones generales que se aplicar√°n a todos los hosts virtuales o configuraciones relacionadas con m√≥dulos espec√≠ficos de Nginx.Usualmente, este directorio se utiliza para ***configuraciones globales*** que afectan a todos los sitios web alojados en el servidor.

`include /etc/nginx/sites-enabled/*;`: incluye todos los archivos ubicados en el directorio `/etc/nginx/sites-enabled/`. Los archivos incluidos aqu√≠ son ***configuraciones espec√≠ficas*** de los host virtuales. Cada archivo `.conf` en este directorio define la configuraci√≥n para un host virtual espec√≠fico, incluyendo detalles como el nombre del servidor, la ruta del directorio ra√≠z del sitio web, las reglas de redirecci√≥n, la configuraci√≥n SSL/TLS, entre otros.

Usualmente, este directorio se utiliza para habilitar o deshabilitar f√°cilmente los host virtuales, ya que los archivos de configuraci√≥n pueden ser simb√≥licamente enlazados desde el directorio `/etc/nginx/sites-available/`, donde se encuentran los archivos de configuraci√≥n disponibles para su uso.

M√°s adelante vamos a dedicar un apartado espec√≠fico a la configuraci√≥n de host virtuales en Nginx.


13. **Configuraci√≥n de correo electr√≥nico (mail)**:

Secci√≥n comentada que muestra un ejemplo de configuraci√≥n para un servidor de correo electr√≥nico, que incluye la autenticaci√≥n y la proxy de protocolos POP3 e IMAP. En este curso no se desarrollar√° esta capacidad del servidor Nginx.

## Configuracion de nginx a grandes rasgos

En Nginx, **la configuraci√≥n es jer√°rquica** ‚Äî es como una estructura de bloques que contienen otros bloques.

El esquema b√°sico es:

![Configuraacion_esquema_principal](../img/nginx-conf-jerarqui-configuracion.png)

---

### 1. `main` (el nivel m√°s alto)
- Aqu√≠ van **directivas globales** para todo el servidor.
- Ejemplos: `worker_processes`, `error_log`, `pid`, etc.
  
```nginx
worker_processes 1;
```

---

### 2. `events` (configura c√≥mo manejar conexiones)
- Solo hay **uno**.
- Controla el comportamiento de las conexiones TCP.
- Ejemplo: n√∫mero m√°ximo de conexiones simult√°neas.

```nginx
events {
    worker_connections 1024;
}
```

---

### 3. `http` (todo lo relacionado a tr√°fico HTTP/HTTPS)
- Este es el **bloque principal para servir sitios web**.
- Dentro de `http {}` defines cosas como:
  - Compresi√≥n (gzip)
  - Caching
  - Inclusi√≥n de sitios virtuales
  - Definici√≥n de servidores (`server {}`)

```nginx
http {
    include /etc/nginx/conf.d/*.conf;
}
```

---

### 4. `server` (un sitio o aplicaci√≥n espec√≠fica)
- Cada `server {}` representa un **sitio web o servicio**.
- Aqu√≠ defines:
  - El puerto (`listen`)
  - El dominio (`server_name`)
  - El directorio base (`root`)
  - SSL si hace falta

```nginx
server {
    listen 80;
    server_name ejemplo.com;
}
```

---

### 5. `location` (gestiona rutas o URLs espec√≠ficas)
- Dentro de un `server {}`, usas `location {}` para:
  - Definir qu√© pasa si piden `/`, `/imagenes/`, `/api`, etc.
  - Aplicar reglas espec√≠ficas (redirigir, bloquear, servir archivos).

```nginx
location / {
    try_files $uri $uri/ =404;
}
```


### Visualmente, ser√≠a algo as√≠:

```
main
 ‚îú‚îÄ‚îÄ events
 ‚îî‚îÄ‚îÄ http
      ‚îú‚îÄ‚îÄ server
      ‚îÇ     ‚îî‚îÄ‚îÄ location
      ‚îú‚îÄ‚îÄ server
      ‚îÇ     ‚îî‚îÄ‚îÄ location
      ‚îî‚îÄ‚îÄ server
            ‚îî‚îÄ‚îÄ location
```

---

**Resumiendo:**
> `main` ‚Üí `events` y `http` ‚Üí `server` ‚Üí `location`

---
![Configuraacion_esquema_principal](../img/nginx-conf-jerarqui-configuracion.png)
---

### (Opcional) Otros bloques:
- `stream {}` ‚Üí Para tr√°fico TCP o UDP (no HTTP).
- `mail {}` ‚Üí (menos usado) para servidores de correo.



```nginx
# --- Contexto MAIN ---
worker_processes 1;
error_log /var/log/nginx/error.log warn;
pid /run/nginx.pid;

# --- Contexto EVENTS ---
events {
    worker_connections 1024;
}

# --- Contexto HTTP (necesario para server y location) ---
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # --- Contexto SERVER ---
    server {
        listen 80;
        server_name ejemplo.com www.ejemplo.com;
        root /var/www/ejemplo;
        index index.html index.htm;

        # --- Contexto LOCATION ---
        location / {
            try_files $uri $uri/ =404;
        }

        # Otro ejemplo de location
        location /imagenes/ {
            root /var/www/imagenes;
        }
    }
}
```

---

## Creaci√≥n de un servidor sencillo en Nginx.


**Creamos una p√°gina web**:

Creamos una carpeta para el contenido de nuestro sitio web.
```bash
sudo mkdir -p /var/www/mi_sitio
```

Editamos el archivo `index.html`.

```bash
sudo nano /var/www/mi_sitio/index.html
```

Pegamos el siguiente contenido y guardamos.

```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Sitio Web</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        h1 {
            color: #333;
        }
    </style>
</head>
<body>
    <h1>Bienvenido a Mi Sitio Web</h1>
    <p>Esta es una p√°gina de ejemplo.</p>
</body>
</html>
```

Ahora nos aseguramos que Nginx tenga permisos para leer los archivos en `/var/www/mi_sitio`.

```bash
sudo chown -R www-data:www-data /var/www/mi_sitio
```

**Configurar la resoluci√≥n DNS**:

Para no tener que disponer de un nombre de dominio en real, vamos a utilizar `/etc/hosts` para la resoluci√≥n DNS, y de esta forma poder configurar el servidor Nginx para que responda a una direcci√≥n IP espec√≠fica.

Para agregar una entrada en el archivo `/etc/hosts` y asociar el nombre de dominio `midominio.local` con la direcci√≥n IP de tu servidor local, puedes seguir estos pasos:

Abre el archivo `/etc/hosts` en tu editor de texto preferido con permisos de superusuario. Puedes hacerlo ejecutando el siguiente comando en tu terminal:

```bash
sudo nano /etc/hosts
```

Agrega al final del archivo, la siguiente l√≠nea.

```
127.0.0.1 midominio.local
```

Guarda los cambios y cierra el editor de texto.

---
---

## Servidor en archivo dedicado
**Configuraci√≥n del servidor:**

En el directorio `/etc/nginx/sites-available/` se almacenan los diferentes sitios web servidos por Nginx. Esta carpeta contiene inicialmente un solo sitio, llamado `default`, tal y como podemos ver en la siguiente imagen.

![P√°gina Nginx](../img/202403301317.png)


Procedemos a crear un nuevo archivo con nombre `mi_sitio` en `/etc/nginx/sites-available/`:
```
sudo nano /etc/nginx/sites-available/mi_sitio
```

Dentro de este archivo, configuramos el sitio, de la siguiente forma

```nginx
server {
      listen 80;
      server_name midominio.local;

      location / {
         root /var/www/mi_sitio;
         index index.html;
      }
}
```


`server { ... }` es un bloque de configuraci√≥n de servidor en Nginx. Contiene todas las directivas necesarias para definir la configuraci√≥n de un servidor virtual. Un servidor virtual es una configuraci√≥n que permite alojar m√∫ltiples sitios web en un √∫nico servidor f√≠sico.

`listen 80;` especifica en qu√© puerto escuchar√° el servidor. En este caso, el servidor Nginx estar√° escuchando en el puerto 80, que es el puerto predeterminado para el tr√°fico HTTP.

`server_name midominio.local;` especifica el nombre del servidor. En este ejemplo, el servidor se llama `midominio.local`. Esto significa que el servidor responder√° a las solicitudes que coincidan con este nombre de dominio. En este caso, estamos usando un nombre de dominio ficticio, `midominio.local`, que est√° configurado en el archivo `/etc/hosts` del servidor.

`location / { ... }` define c√≥mo manejar las solicitudes que coinciden con la ruta `/`, es decir, el directorio ra√≠z del sitio web. 

`root /var/www/mi_sitio;` especifica la ruta del directorio ra√≠z donde se encuentran los archivos del sitio web. En este caso, los archivos del sitio web se encuentran en `/var/www/mi_sitio`.

`index index.html;` especifica el nombre del archivo que se utilizar√° como p√°gina de inicio del sitio web. En este caso, si alguien accede al directorio ra√≠z del sitio web (por ejemplo, `http://midominio.local/`), Nginx buscar√° un archivo llamado `index.html` en el directorio ra√≠z del sitio web y lo servir√° como p√°gina de inicio.

Guardamos y salimos del editor.


**Habilitar el host virtual:**
   
En Nginx, la relaci√≥n entre los directorios `sites-available` y `sites-enabled` se utiliza para organizar y gestionar los archivos de configuraci√≥n de los servidores virtuales (host virtuales).

En `sites-available` se almacenan los archivos de configuraci√≥n de los servidores virtuales disponibles. Estos archivos contienen la configuraci√≥n para los diferentes sitios web que pueden ser servidos por Nginx. Sin embargo, los servidores virtuales definidos en estos archivos ***no est√°n activos de forma predeterminada***.

En `sites-enabled` se crean `enlaces simb√≥licos` de los archivos de configuraci√≥n ubicados en `sites-available` que se desean activar. Solo los archivos que se encuentran en este directorio son considerados activos por Nginx y se utilizan para servir el tr√°fico web.

La idea detr√°s de esta estructura es proporcionar una forma conveniente de habilitar y deshabilitar servidores virtuales sin tener que mover o renombrar archivos de configuraci√≥n. Al mantener los archivos de configuraci√≥n separados en `sites-available`, podemos tener una colecci√≥n de configuraciones listas para ser activadas seg√∫n sea necesario. Cuando deseemoss habilitar un servidor virtual, simplemente creamoss un enlace simb√≥lico desde `sites-available` a `sites-enabled`.

Por ejemplo, supongamos que tienes un archivo de configuraci√≥n llamado `mi_sitio` en `sites-available`. Para habilitarlo, puedes crear un enlace simb√≥lico en `sites-enabled` usando el siguiente comando:

Creamos el enlace simb√≥lico para habilitar el sitio web:

```
sudo ln -s /etc/nginx/sites-available/mi_sitio /etc/nginx/sites-enabled/
```

La siguiente imagen muestra el resultado de esta acci√≥n.

![enlace simb√≥lico](../img/202403301340.png)



4. **Verificar la configuraci√≥n:**
   Verifica que la configuraci√≥n de Nginx no tenga errores de sintaxis:
   ```
   sudo nginx -t
   ```

5. **Reiniciar Nginx:**
   Reinicia Nginx para aplicar los cambios:
   ```
   sudo systemctl restart nginx
   ```

Con el navegador, con√©ctate a:
```http
http://midominio.local
```

## ACTIVIDAD PR√ÅCTICA.

Esta actividad busca ver las diferencias (y similitudes) de como definir un host virtual aparte y dentro el fichero de configuracion principal. Se busca  entender que hay varias formas de hacer lo mismo (aunque una de ellas sea m√°s l√≥gica y estructurada que la otra). 

Partiendo de la base de que hemos ejecutado (y entendido) los pasos anterriores. Se pide:
1. Deshabilitar el host virtual en su fichero destinado a ello.
2. Introducir las configuraciones necesiarias en el fichero principal de configuracion de nginx.
3. Probar la configuracion por linea de comando antes de reiniciar el servicio (y hacer las correcciones pertinentes en caso de ser necesario)
4. Reiniciar el servicio y probar en el navegador web.


## ACTIVIDAD PR√ÅCTICA (OTRA).

Configura Nginx para que use dos nuevos hosts virtuales de la siguente forma:

- Host Virtual 1: Debe responder al las peticiones a la ra√≠z del sitio `miDominioA.local`.
- Host Virtual 2: Debe responder al las peticiones a la ra√≠z del sitio `miDominioB.local`.

Comprueba con el navegador que todo funciona correctamente.

- Elimina el enlace simb√≥lico a `midominio.local`.

Comprueba con el navegador que `midominio.local` no es accesible.

- Vuelve habilitar `midominio.local` y deshabilita `miDominioA.local`

Comprueba con el navegador que solo responde `miDominioB.local`.

- Elimina de forma definitiva los hosts virtuales `midominio.local`, `miDominioA.local`y `miDominioB.local`.



[Vamos al siguiente contenido](10-D.md)
